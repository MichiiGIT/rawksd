name: Build rawksd (Riivolution + RawkSD)

on:
  workflow_dispatch:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

permissions:
  contents: read

jobs:
  riivolution:
    name: Riivolution (launcher)
    runs-on: ubuntu-latest
    container:
      image: devkitpro/devkitppc:20210726

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fix APT sources (Debian buster -> archive)
        run: |
          set -e
          cat > /etc/apt/sources.list <<'EOF'
          deb http://archive.debian.org/debian buster main contrib non-free
          deb http://archive.debian.org/debian-security buster/updates main contrib non-free
          EOF
          echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until

      - name: Install deps (zip + 32-bit runtime libs)
        run: |
          set -e
          dpkg --add-architecture i386
          apt-get -o Acquire::Check-Valid-Until=false update
          apt-get install -y --no-install-recommends \
            ca-certificates zip g++ \
            libgcc1:i386 zlib1g:i386

      - name: Build launcher
        run: make launcher -j

      - name: Upload riiv.zip
        uses: actions/upload-artifact@v4
        with:
          name: riivolution
          path: launcher/riiv.zip
          if-no-files-found: error

  rawksd:
    name: RawkSD
    runs-on: ubuntu-latest
    container:
      image: devkitpro/devkitppc:20210726

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fix APT sources (Debian buster -> archive)
        run: |
          set -e
          cat > /etc/apt/sources.list <<'EOF'
          deb http://archive.debian.org/debian buster main contrib non-free
          deb http://archive.debian.org/debian-security buster/updates main contrib non-free
          EOF
          echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until

      - name: Install deps (zip + python)
        run: |
          set -e
          dpkg --add-architecture i386
          apt-get -o Acquire::Check-Valid-Until=false update
          apt-get install -y --no-install-recommends \
            ca-certificates zip g++ \
            libgcc1:i386 zlib1g:i386 \
            python3 python3-yaml

      - name: Build rawksd
        run: make rawksd -j

      - name: Upload rawk.zip
        uses: actions/upload-artifact@v4
        with:
          name: rawksd
          path: rawksd/rawk.zip
          if-no-files-found: error
