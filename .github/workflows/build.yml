name: Build rawksd (Riivolution + RawkSD)

on:
  workflow_dispatch: {}
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  riiv:
    name: Riivolution
    runs-on: ubuntu-latest
    container:
      image: devkitpro/devkitppc:20210726

    steps:
      - uses: actions/checkout@v4

      - name: Fix APT sources (Debian buster -> archive)
        run: |
          set -eux
          # buster ist EOL -> auf archive.debian.org umstellen + Valid-Until deaktivieren
          if [ -f /etc/apt/sources.list ]; then
            sed -i 's|http://deb.debian.org/debian|http://archive.debian.org/debian|g' /etc/apt/sources.list
            sed -i 's|http://security.debian.org/debian-security|http://archive.debian.org/debian-security|g' /etc/apt/sources.list
            sed -i 's|http://security.debian.org|http://archive.debian.org|g' /etc/apt/sources.list
            # buster-updates existiert so nicht mehr zuverlÃ¤ssig
            sed -i '/buster-updates/d' /etc/apt/sources.list
            echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until
          fi

      - name: Dependencies (zip + 32-bit runtime libs)
        run: |
          set -eux
          dpkg --add-architecture i386
          apt-get -o Acquire::Check-Valid-Until=false update
          apt-get install -y --no-install-recommends \
            ca-certificates zip g++ \
            libgcc1:i386 zlib1g:i386

      - name: Build launcher
        run: make launcher -j$(nproc)

      - name: Upload riivolution artifact
        uses: actions/upload-artifact@v4
        with:
          name: riivolution
          path: launcher/riiv.zip

      - name: Build riifs
        run: make riifs -j$(nproc)

  rawk:
    name: RawkSD
    runs-on: ubuntu-latest
    container:
      image: devkitpro/devkitppc:20210726

    steps:
      - uses: actions/checkout@v4

      - name: Fix APT sources (Debian buster -> archive)
        run: |
          set -eux
          if [ -f /etc/apt/sources.list ]; then
            sed -i 's|http://deb.debian.org/debian|http://archive.debian.org/debian|g' /etc/apt/sources.list
            sed -i 's|http://security.debian.org/debian-security|http://archive.debian.org/debian-security|g' /etc/apt/sources.list
            sed -i 's|http://security.debian.org|http://archive.debian.org|g' /etc/apt/sources.list
            sed -i '/buster-updates/d' /etc/apt/sources.list
            echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until
          fi

      - name: Dependencies (zip + python + 32-bit runtime libs)
        run: |
          set -eux
          dpkg --add-architecture i386
          apt-get -o Acquire::Check-Valid-Until=false update
          apt-get install -y --no-install-recommends \
            ca-certificates zip g++ \
            libgcc1:i386 zlib1g:i386 \
            python3 python3-yaml

      - name: Build rawksd
        run: make rawksd -j$(nproc)

      - name: Upload rawksd artifact
        uses: actions/upload-artifact@v4
        with:
          name: rawksd
          path: rawksd/rawk.zip

  msys2:
    name: Windows MSYS2
    runs-on: windows-latest
    continue-on-error: true
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - uses: msys2/setup-msys2@v2
        with:
          release: false
          install: >-
            base-devel gcc python-yaml zip unzip python git

      - name: devkitPro repos + keyring
        run: |
          set -eux
          pacman-key --recv BC26F752D25B92CE272E0F44F7FD5492264BB9D0 --keyserver keyserver.ubuntu.com || pacman-key --recv BC26F752D25B92CE272E0F44F7FD5492264BB9D0
          pacman-key --lsign BC26F752D25B92CE272E0F44F7FD5492264BB9D0
          pacman --noconfirm -U https://pkg.devkitpro.org/devkitpro-keyring.pkg.tar.xz
          echo -e '[dkp-libs]\nServer = https://pkg.devkitpro.org/packages' >> /etc/pacman.conf
          echo -e '[dkp-windows]\nServer = https://pkg.devkitpro.org/packages/windows/$arch/' >> /etc/pacman.conf
          sed -i 's/^CheckSpace/#CheckSpace/g' /etc/pacman.conf
          pacman --noconfirm -Sy
          pacman --noconfirm -S --needed wii-dev ppc-portlibs wii-portlibs devkitARM

      - uses: actions/checkout@v4

      - name: make launcher
        run: |
          DEVKITPRO=/opt/devkitpro DEVKITPPC=$DEVKITPRO/devkitPPC DEVKITARM=$DEVKITPRO/devkitARM \
          make launcher -j

      - name: upload msys2-riivolution
        uses: actions/upload-artifact@v4
        with:
          name: msys2-riivolution
          path: launcher/riiv.zip

      - name: make rawksd
        run: |
          PYTHON=/usr/bin/python3.exe \
          DEVKITPRO=/opt/devkitpro DEVKITPPC=$DEVKITPRO/devkitPPC DEVKITARM=$DEVKITPRO/devkitARM \
          make rawksd -j

      - name: upload msys2-rawksd
        uses: actions/upload-artifact@v4
        with:
          name: msys2-rawksd
          path: rawksd/rawk.zip
